trigger:
  batch: true
  branches:
    include:
      - main
      - feature/*
      - gh-readonly-queue/*
  paths:
    exclude:
      - doc/*
      - samples/*
      - tools/*

pr:
  branches:
    include:
      - main
      - feature/*
  paths:
    exclude:
      - doc/*
      - samples/*
      - tools/*

variables:
  - name: runCodesignValidationInjectionBG
    value: false

name: $(BuildDefinitionName)_$(date:yyMM).$(date:dd)$(rev:rrr)

parameters:
  - name: runTests
    displayName: "Run Tests"
    type: boolean
    default: true
  - name: buildPlatforms
    type: object
    default:
      - x64
      - arm64

stages:
  - ${{ each platform in parameters.buildPlatforms }}:
    - stage: Build_${{ platform }}
      displayName: Build ${{ platform }}
      dependsOn: []
      jobs:
        - template: ./templates/job-build-project.yml
          parameters:
            pool:
              ${{ if eq(variables['System.CollectionId'], 'cb55739e-4afe-46a3-970f-1b49d8ee7564') }}:
                name: SHINE-INT-L
              ${{ else }}:
                name: SHINE-OSS-L
            buildPlatforms: [ ${{ platform }} ]
            buildConfigurations: [Release]

    - ${{ if eq(parameters.runTests, true) }}:
      - stage: Test_${{ platform }}
        displayName: Test ${{ platform }}
        dependsOn:
          - Build_${{ platform }}
        condition: succeeded()
        jobs:
          - template: ./templates/job-test-project.yml
            parameters:
              platform: ${{ platform }}
              # The tests might be run more than once; log one artifact per attempt.
              outputArtifactStem: -$(System.JobAttempt)
